#!/usr/bin/env ruby

require 'fileutils'

DIR = File.basename(Dir.pwd)

class GemTemplate

  def self.create!
    new_gem = self.new
    new_gem.create_readme
    new_gem.create_lib
    new_gem.create_tests
    new_gem.create_gemspec
    new_gem.create_gemfile
    new_gem.create_rakefile
    new_gem
  end

  def dir
    ::DIR
  end

  def gem_path
    dir.gsub('-', '/')
  end

  def name
    dir.split('-').map { |seg| seg.gsub(/(?:^|_| )(.)/) { $1.upcase } }.join('::')
  end

  def lib_dir
    "lib/#{gem_path}"
  end

  def lib
    "lib/#{gem_path}.rb"
  end

  def create_lib
    FileUtils.mkdir_p(lib_dir)
    File.open(lib, "w+") { |file| file.puts lib_template }
    File.open("#{lib_dir}/version.rb", "w+") { |file| file.puts version_template }
  end

  def create_tests
    FileUtils.mkdir("test")
    File.open("test/test_helper.rb", "w+") { |file| file.puts test_helper_template }
  end

  def create_gemspec
    File.open("#{dir}.gemspec", "w+") { |file| file.puts gemspec_template }
  end

  def create_gemfile
    File.open("Gemfile", "w+") { |file| file.puts gemfile_template }
  end

  def create_rakefile
    File.open("Rakefile", "w+") { |file| file.puts rakefile_template }
  end

  def create_readme
    File.open("README.markdown", "w+") { |file| file.puts readme_template }
  end

  def write_module(code = nil)
    out  = []
    segs = name.split('::')
    segs.each_with_index do |seg, index|
      indent = '  ' * index
      out << "#{indent}module #{seg}"
    end

    out << "#{'  ' * (segs.count - 1)}  #{code}" if code

    segs.each_with_index do |seg, index|
      indent = '  ' * (segs.count - 1 - index)
      out << "#{indent}end"
    end
    out.join("\n")
  end

  def lib_template
    write_module %{autoload :Version, "#{gem_path}/version"}
  end

  def test_helper_template; <<-TEMPLATE
require 'rubygems'
require 'test/unit'
require 'shoulda'

begin
  require 'turn'
rescue LoadError
end

require '#{gem_path}'
TEMPLATE
  end

  def gemspec_template; <<-TEMPLATE
$:.unshift 'lib'

require '#{gem_path}/version'

Gem::Specification.new do |s|
  s.name             = '#{dir}'
  s.version          = #{name}::Version
  s.date             = Time.now.strftime('%Y-%m-%d')
  s.summary          = '#{name}: Description here'
  s.homepage         = 'https://github.com/itspriddle/#{dir}'
  s.authors          = ['Joshua Priddle']
  s.email            = 'jpriddle@nevercraft.net'

  s.files            = %w[ Rakefile README.markdown ]
  #s.files           += Dir['bin/**/*']
  s.files           += Dir['lib/**/*']
  s.files           += Dir['test/**/*']

  # s.executables      = ['#{dir}']

  # s.add_dependency('gem', '= 0.0.0')

  s.add_development_dependency('shoulda')

  s.extra_rdoc_files = ['README.markdown']
  s.rdoc_options     = ["--charset=UTF-8"]

  s.description = <<-DESC
    #{name}: Description here
  DESC
end
TEMPLATE
  end

  def gemfile_template
    "gemspec\n"
  end

  def rakefile_template; <<-TEMPLATE
$:.unshift 'lib'

task :default => :test

require 'rake/testtask'
Rake::TestTask.new(:test) do |test|
  test.libs << 'lib' << 'test' << '.'
  test.pattern = 'test/**/*_test.rb'
  test.verbose = true
end

desc "Open an irb session preloaded with this library"
task :console do
  sh "irb -rubygems -r ./#{lib} -I ./lib"
end

require 'sdoc_helpers'
desc "Push a new version to Gemcutter"
task :publish do
  require '#{gem_path}/version'

  ver = #{name}::Version

  sh "gem build #{dir}.gemspec"
  sh "gem push #{dir}-\#{ver}.gem"
  sh "git tag -a -m '#{name} v\#{ver}' v\#{ver}"
  sh "git push origin v\#{ver}"
  sh "git push origin master"
  sh "git clean -fd"
  sh "rake pages"
end
TEMPLATE
  end

  def readme_template; <<-TEMPLATE
# #{name}

Description Here
TEMPLATE
  end

  def version_template
    write_module "VERSION = Version = '0.0.0'"
  end
end

new_gem = GemTemplate.create!

puts <<-MSG

  Setup #{new_gem.name}!

MSG
