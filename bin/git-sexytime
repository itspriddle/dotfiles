#!/bin/sh
# Usage: git sexytime [options]
#
# Help: Pushes the current branch upstream and opens a Pull Request. On OS X,
# the PR URL is copied to the clipboard. Requires a repo with github.com as
# the remote named origin and the `hub` CLI tool https://github.com/github/hub
#
# Examples:
#     git sexytime
#     git sexytime -b base-branch
#     git sexytime -m "This is my PR"
#     echo "This is my PR" | git sexytime -F -

set -e

# Internal, used with the $BROWSER variable to copy the pull request URL to
# the clipboard.
if [[ "$1" = "--pbcopy" ]]; then
  shift
  echo $1 | pbcopy
  exit
fi

if ! type hub &> /dev/null; then
  echo "Error: \`hub\` not found. Install from https://github.com/github/hub"
  exit 1
fi

if ! git remote show origin | grep Push | grep github &> /dev/null; then
  echo "Error: Remote does not seem to be on GitHub."
  exit 1
fi

branch=$(git symbolic-ref HEAD | sed 's|refs/heads/||g')

if [[ "$branch" = "master" ]]; then
  echo "Error: You are on \`master', checkout a new branch first!"
  exit 1
fi

git push -u origin $branch

if [[ "$OSTYPE" = darwin* ]]; then
  # Hack to copy the pull request URL to the clipboard automatically
  BROWSER="$0 --pbcopy" hub pull-request -o "$@"
  echo "Created pull request - $(pbpaste)"
else
  hub pull-request "$@"
fi
