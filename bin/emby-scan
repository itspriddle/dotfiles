#!/usr/bin/env bash
# Usage: emby-scan <shows|movies|all>
#
# NAME
#   emby-scan -- trigger library scans in Emby
#
# CONFIGURATION
#   Create `~/.config/emby.json` with the following:
#
#   {
#     "url": "http://emby.local:8096",
#     "key": "cccccccccccccccccccccccccccccccc",
#     "movies_id": 4,
#     "shows_id": 6
#   }
#
#   You need to find your library IDs from your own Emby instance. Open Emby
#   in a web browser and then click on Movies. Look at the URL for a parameter
#   like `parentId=4`. The number here is your `movies_id` for the config
#   file. Click on TV Shows and locate `parentId` in that URL to set
#   `shows_id`.

if [[ "$DEBUG" ]]; then
  export PS4='+ [${BASH_SOURCE##*/}:${LINENO}] '
  set -x
fi

set -euo pipefail

CONFIG_FILE="$HOME/.config/emby.json"

read_config() {
  if ! type jq &> /dev/null; then
    echo "Missing \`jq' command." >&2
    return 1
  fi

  if [[ ! -r "$CONFIG_FILE" ]]; then
    echo "Config '$CONFIG_FILE' doesn't exist" >&2
    return 1
  fi

  jq -r 'to_entries |
    map("EMBY_\(.key | tostring | ascii_upcase)=\(.value | tostring)") |
    .[]
  ' "$CONFIG_FILE"
}

load_config() {
  if [[ "${EMBY_CONFIG_LOADED-}" ]]; then
    return 0
  fi

  for var in $(read_config); do
    case "${var%=*}" in
      EMBY_URL|EMBY_KEY|EMBY_MOVIES_ID|EMBY_SHOWS_ID)
        export "${var?}"
        ;;
    esac
  done

  local ret=0

  if [[ -z "${EMBY_URL-}" ]]; then
    echo "Must set 'url' in $CONFIG_FILE" >&2
    ret=1
  fi

  if [[ -z "${EMBY_KEY-}" ]]; then
    echo "Must set 'key' in $CONFIG_FILE" >&2
    ret=1
  fi

  if [[ -z "${EMBY_MOVIES_ID-}" ]]; then
    echo "Must set 'movies_id' in $CONFIG_FILE" >&2
    ret=1
  fi

  if [[ -z "${EMBY_SHOWS_ID-}" ]]; then
    echo "Must set 'shows_id' in $CONFIG_FILE" >&2
    ret=1
  fi

  export EMBY_CONFIG_LOADED=1

  return $ret
}

api_request() {
  local lib_id="$1" query

  load_config

  local api_params=(
    Recursive=true
    MetadataRefreshMode=Default
    ImageRefreshMode=Default
    ReplaceAllMetadata=false
    ReplaceAllImages=false
    "api_key=$EMBY_KEY"
  )

  query="$(IFS='&'; echo "${api_params[*]}")"

  curl -X POST \
    -H "Accept: */*" \
    -H "Content-Type: application/json" \
    "$EMBY_URL/emby/Items/${!lib_id}/Refresh?$query"
}

main() {
  local cmd="${1--h}"

  case "$cmd" in
    movies)
      api_request EMBY_MOVIES_ID
      echo "Triggered movies scan"
      ;;
    shows)
      api_request EMBY_SHOWS_ID
      echo "Triggered shows scan"
      ;;
    all)
      main movies
      main shows
      ;;
    help|--help|-h)
      sed -ne '/^#/!q;s/^#$/# /;/^# /s/^# //p' < "$0" |
        awk -v f="${cmd#-h}" '!f && /^Usage:/ || u { u=!/^\s*$/; if (!u) exit } u || f'
      return 1
      ;;
    *)
      main -h >&2
      ;;
  esac
}

main "$@"
