#!/usr/bin/env ruby
# Usage: changelog >> CHANGELOG.markdown

unless `git rev-parse --show-toplevel &> /dev/null` and $?.success?
  abort "fatal: Not a git repository (or any of the parent directories): .git"
end

cmd = 'git log --pretty="* %s [%cn]" --no-merges'

if current_tag = `git describe 2> /dev/null`.chomp and $?.success?
  title = "#{current_tag} (#{Time.now.strftime("%Y-%m-%d")})"
  cmd << " #{current_tag}..HEAD"
else
  if File.exists? "CHANGELOG.markdown"
    since = File.mtime("CHANGELOG.markdown")
    cmd << " --since='#{since}'"
  end

  title = (since || Time.now).strftime("%Y-%m-%d")
end

puts (["# #{title}\n\n"] + `#{cmd}`.chomp.lines.to_a).join
