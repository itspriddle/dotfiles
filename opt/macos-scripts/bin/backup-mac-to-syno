#!/usr/bin/env bash

target="$(hostname -s)"

if [[ -z "$target" ]]; then
  echo "Uh oh, couldn't determine target from hostname" >&2
  exit 1
fi

folders=(~/Downloads ~/Pictures ~/Sites ~/work)

printf '%s\n' "${folders[@]}" | \
  parallel -j 5 --bar --tag --line-buffer \
    rsync "$@" \
      --stats \
      --delete \
      --partial \
      --verbose \
      --log-file="$HOME/Library/Logs/rsync-mac-{#}.log" \
      --archive \
      -e "ssh" \
      {} "scarif.priddle.network:/volume1/NetBackup/$target/"

echo -e "\n=== Backup Summary ==="
grep -h "Total transferred file size" "$HOME/Library/Logs/rsync-mac-"*.log | \
  awk '{sum+=$5} END {print "Total transferred:", sum, "bytes"}'
