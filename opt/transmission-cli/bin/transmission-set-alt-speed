#!/usr/bin/env bash

# Enable debug mode
if [[ "$DEBUG" ]]; then
  export PS4='+ [${BASH_SOURCE##*/}:$LINENO] '
  set -x
fi

set -euo pipefail

get_session() {
  local response

  transmission-api 2> /dev/null
}

payload() {
  local enabled="$1"

  jq -n --arg enabled "$enabled" '
    .method = "session-set" |
    .arguments."alt-speed-enabled" = ($enabled | test("true"; "i"))
  '
}

toggle() {
  local enabled="$1" session_id="$2" response

  response=$(payload "$enabled" |
    transmission-api --session="$session_id" -d @-
  )

  response_code="$(jq -r .__response_code <<< "$response")"

  if [[ $response_code -eq 200 ]]; then
    if [[ "$enabled" == "true" ]]; then
      echo "Enabled alt-speed"
    else
      echo "Disabled alt-speed"
    fi
  else
    echo "Unexpected response code: $response_code" >&2
    return 1
  fi
}

main() {
  local enabled="${1:-true}"

  case "$enabled" in
    true|false)
      ;;
    on)
      enabled=true
      ;;
    off)
      enabled=false
      ;;
    *)
      echo "Invalid argument: $enabled" >&2
      return 1
      ;;
  esac

  toggle "$enabled" "$(get_session)"
}

main "$@"
