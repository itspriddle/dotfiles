#!/usr/bin/env bash

# "%": untracked files in repo
# export GIT_PS1_SHOWUNTRACKEDFILES=1

# "+": staged
# "*": unstaged
export GIT_PS1_SHOWDIRTYSTATE=1

# "$": something stashed
# export GIT_PS1_SHOWSTASHSTATE=1

_josh_prompt_command() {
  local blue="\[\e[1;34m\]"
  local green="\[\e[1;32m\]"
  local yellow="\[\e[1;33m\]"
  local reset="\[\e[0m\]"

  local git=$(__git_ps1 " ${green}(%s)${reset}" 2> /dev/null)

  local host=

  if [ "$SSH_CONNECTION" ]; then
    host="${yellow}\u@\H${reset} "
  fi

  local pat=$(printf '/*%.0s' {1..3})
  local cwd=${PWD/$HOME/\~}
  local tmp=${cwd%$pat}

  if [ ${#tmp} -gt 0 -a "$tmp" != "$cwd" ]; then
    prompt_cwd=$(printf "${cwd:${#tmp}+1}")
  else
    prompt_cwd=$(printf "$cwd")
  fi

  PS1="${host}${blue}${prompt_cwd}${reset}${git} $ "

  case "$TERM" in
    xterm*|rxvt*)
      if [ "$SSH_CONNECTION" ]; then
        printf '\e]0;%s@%s:%s\a' "$USER" "$HOSTNAME" "${prompt_cwd}"
      else
        printf '\e]0;%s\a' "${prompt_cwd}"
      fi
      ;;
  esac
}

export PROMPT_COMMAND="_josh_prompt_command${PROMPT_COMMAND:+; $PROMPT_COMMAND}"
