#!/usr/bin/env bash

FEEDS=/volume1/docker/network.priddle.home/public/feeds/vnstat

[[ ! -d "$FEEDS" ]] && mkdir "$FEEDS"

BIN=~/.dotfiles/share/opnsense/bandwidth-json

hourly=$("$BIN" hourly | tee "$FEEDS/hourly.json.tmp")
daily=$("$BIN" daily | tee "$FEEDS/daily.json.tmp" "$FEEDS/now.json.tmp")
monthly=$("$BIN" monthly | tee "$FEEDS/monthly.json.tmp")
yearly=$("$BIN" yearly | tee "$FEEDS/yearly.json.tmp")

jq -n \
  --arg     fetched_at "$(date '+%F %T')" \
  --argjson hourly     "$hourly" \
  --argjson daily      "$daily" \
  --argjson monthly    "$monthly" \
  --argjson yearly     "$yearly" \
  '{
    $fetched_at,
    hourly:  ($hourly | del(.fetched_at)),
    daily:   ($daily | del(.fetched_at)),
    monthly: ($monthly | del(.fetched_at)),
    yearly:  ($yearly | del(.fetched_at))
  }' | tee "$FEEDS/all.json.tmp"

mv -f "$FEEDS/hourly.json.tmp" "$FEEDS/hourly.json"
mv -f "$FEEDS/daily.json.tmp" "$FEEDS/daily.json"
mv -f "$FEEDS/now.json.tmp" "$FEEDS/now.json"
mv -f "$FEEDS/monthly.json.tmp" "$FEEDS/monthly.json"
mv -f "$FEEDS/yearly.json.tmp" "$FEEDS/yearly.json"
mv -f "$FEEDS/all.json.tmp" "$FEEDS/all.json"
