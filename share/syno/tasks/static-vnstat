#!/usr/bin/env bash

# Enable debug mode
if [[ "$DEBUG" ]]; then
  export PS4='+ [${BASH_SOURCE##*/}:$LINENO] '
  set -x
fi

set -euo pipefail

FEEDS=/volume1/docker/network.priddle.home/public/feeds/vnstat

[[ ! -d "$FEEDS" ]] && mkdir "$FEEDS"

FHOUR="$(date '+%F-%H')00"
FDAY="$(date '+%F')"
FMONTH="$(date '+%Y-%m')"
FYEAR="$(date '+%Y')"

HOURLY_FILES=(
  "$FEEDS/hourly/now.json.tmp"
  "$FEEDS/hourly/$FDAY/$FHOUR.json.tmp"
)

DAILY_FILES=(
  "$FEEDS/daily/now.json.tmp"
  "$FEEDS/daily/$FYEAR/$FDAY.json.tmp"
)

MONTHLY_FILES=(
  "$FEEDS/monthly/now.json.tmp"
  "$FEEDS/monthly/$FYEAR/$FMONTH.json.tmp"
)

YEARLY_FILES=(
  "$FEEDS/yearly/now.json.tmp"
  "$FEEDS/yearly/$FYEAR.json.tmp"
)

for f in "${HOURLY_FILES[@]}" "${DAILY_FILES[@]}" "${MONTHLY_FILES[@]}" "${YEARLY_FILES[@]}"; do
  mkdir -p "$(dirname "$f")"
done

STATS="$(opnsense-vnstat | tee "$FEEDS/now.json.tmp")"

jq .hourly <<< "$STATS" | tee "${HOURLY_FILES[@]}"
jq .daily <<< "$STATS" | tee "${DAILY_FILES[@]}"
jq .monthly <<< "$STATS" | tee "${MONTHLY_FILES[@]}"
jq .yearly <<< "$STATS" | tee "${YEARLY_FILES[@]}"

for f in "$FEEDS/now.json.tmp" "${HOURLY_FILES[@]}" "${DAILY_FILES[@]}" "${MONTHLY_FILES[@]}" "${YEARLY_FILES[@]}"; do
  mv -f "$f" "${f%%.tmp}"
done
